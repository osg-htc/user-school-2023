
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://osg-htc.org/user-school-2023/materials/software/part2-ex4-matlab/">
      
      <link rel="icon" href="../../../assets/OSG_Logo.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.0">
    
    
      
        <title>Part2 ex4 matlab - OSG School 2023</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.33e2939f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../../stylesheets/code-highlight.css">
    
      <link rel="stylesheet" href="../../../stylesheets/osg.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#software-exercise-24-running-compiled-matlab" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="OSG School 2023" class="md-header__button md-logo" aria-label="OSG School 2023" data-md-component="logo">
      
  <img src="../../../assets/OSG_Logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OSG School 2023
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Part2 ex4 matlab
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="OSG School 2023" class="md-nav__button md-logo" aria-label="OSG School 2023" data-md-component="logo">
      
  <img src="../../../assets/OSG_Logo.svg" alt="logo">

    </a>
    OSG School 2023
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../schedule/" class="md-nav__link">
        Schedule
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../health/" class="md-nav__link">
        Health Guidelines
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        Logistics
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Logistics" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Logistics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../logistics/" class="md-nav__link">
        General information
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      <label class="md-nav__link" for="__nav_4_2">
        Travel
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Travel" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Travel
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../logistics/travel-planning/" class="md-nav__link">
        Travel planning
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../logistics/travel-form/" class="md-nav__link">
        Travel Inc form tips
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../logistics/local-transportation/" class="md-nav__link">
        Local transportation
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../logistics/visas/" class="md-nav__link">
        Visa requirements
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../logistics/hotel/" class="md-nav__link">
        Hotel information
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../logistics/location/" class="md-nav__link">
        School location
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matlab-code" class="md-nav__link">
    Matlab Code
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compiling-matlab-code" class="md-nav__link">
    Compiling Matlab Code
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matlab-runtime" class="md-nav__link">
    Matlab Runtime
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wrapper-script" class="md-nav__link">
    Wrapper Script
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#submitting-the-job" class="md-nav__link">
    Submitting the Job
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <style type="text/css"> pre em { font-style: normal; background-color: yellow; } pre strong { font-style: normal; font-weight: bold; color: #008; } </style>

<h1 id="software-exercise-24-running-compiled-matlab">Software Exercise 2.4: Running Compiled Matlab<a class="headerlink" href="#software-exercise-24-running-compiled-matlab" title="Permanent link">&para;</a></h1>
<p>The goal of this exercise is to compile Matlab code and run it. This exercise will draw on the idea of writing a wrapper script to install and run code, first introduced in <a href="../part1-ex2-wrapper">Exercise 1.2</a> and should take 25-30 minutes.</p>
<h2 id="background">Background<a class="headerlink" href="#background" title="Permanent link">&para;</a></h2>
<p>Matlab is licensed; however, unlike most licensed software, it has the ability to be compiled and the compiled code can be run without a license. We will be compiling Matlab <code>.m</code> files into a binary file and running that binary using a set of files called the Matlab runtime.</p>
<h2 id="matlab-code">Matlab Code<a class="headerlink" href="#matlab-code" title="Permanent link">&para;</a></h2>
<ol>
<li>Log in to the CHTC submit server (<code>learn.chtc.wisc.edu</code>).</li>
<li>Create a directory for this exercise and <code>cd</code> into it . </li>
<li>Copy the following code into a file called <code>matrix.m</code> <div class="codehilite"><pre><span></span><code>A = randi(100,4,4)
b = randi(100,4,1);
x = A*b
save results.txt x -ascii
</code></pre></div>

</li>
</ol>
<h2 id="compiling-matlab-code">Compiling Matlab Code<a class="headerlink" href="#compiling-matlab-code" title="Permanent link">&para;</a></h2>
<p>The first step in making Matlab portable is compiling our Matlab script.
To compile this code, we need to access the machines with the Matlab compiler installed.
For this exercise, we will use the compilers installed on special CHTC build machines.
In the CHTC pool, you can't use <code>ssh</code> to directly connect to these machines.
Instead, you must submit an interactive job (similar to <a href="../part2-ex2-prepackaged">Exercise 2.2</a>) that
specifically requests these build machines.</p>
<ol>
<li>
<p>Create a file called <code>compile.submit</code> with the lines below: </p>
<div class="codehilite"><pre><span></span><code>log = compile.log

should_transfer_files = YES
when_to_transfer_output = ON_EXIT
transfer_input_files = matrix.m

+IsBuildJob = true
request_memory = 1GB
request_disk = 512MB

queue
</code></pre></div>

</li>
<li>
<p>You can initiate the interactive job by using <code>condor_submit</code> 's <code>-i</code> option. Enter the following command: </p>
<div class="codehilite"><pre><span></span><code><span class="gp">username@learn $ </span>condor_submit -i compile.submit
</code></pre></div>

<p>Make sure you've submitted this command from <code>learn.chtc.wisc.edu</code>! Once the job starts, continue with the following instructions.</p>
</li>
<li>
<p>Since you are a guest user on our system, you will need to set your <code>HOME</code> directory by running this command: </p>
<div class="codehilite"><pre><span></span><code><span class="gp">username@build $ </span><span class="nb">export</span> <span class="nv">HOME</span><span class="o">=</span><span class="nv">$PWD</span>
</code></pre></div>

</li>
<li>
<p>The Matlab software on these build servers is accessible via modules, just like the software installed on OSG Connect. Check which modules are available and then load the older version of Matlab. </p>
<div class="codehilite"><pre><span></span><code><span class="gp">username@build $ </span>module load MATLAB/R2015b
</code></pre></div>

</li>
<li>
<p>Once the module is loaded (you can check by running <code>module list</code>), compile the <code>matrix.m</code> file with this command: </p>
<div class="codehilite"><pre><span></span><code><span class="gp">username@build $ </span>mcc -m -R -singleCompThread -R -nodisplay -R -nojvm matrix.m
</code></pre></div>

<p>The extra arguments to the <code>mcc</code> command are very important here. Matlab, by default, will run on as many CPUs as it can find. This can be a big problem  when running on someone else's computers, because your Matlab code might interfere with what the owner wants. The <code>-singleCompThread</code> option  compiles the code to run on a single CPU, avoiding this problem. In addition, the <code>-nodisplay</code> and <code>-nojvm</code> options turn off the display (which won't exist  where the code runs). </p>
</li>
<li>
<p>To exit the interactive session, type <code>exit</code></p>
</li>
<li>
<p>Now that you're back on the submit server, look at the files that were created by the Matlab compiler. Which one is the compiled binary?</p>
</li>
</ol>
<h2 id="matlab-runtime">Matlab Runtime<a class="headerlink" href="#matlab-runtime" title="Permanent link">&para;</a></h2>
<p>The newly compiled binary will require the 2015b Matlab runtime to run. You can download the runtime from the Mathworks website and build it yourself, but to save time, for this exercise you can use the pre-built runtimes hosted by CHTC.</p>
<ol>
<li>Download the 2015b Matlab runtime hosted by CHTC: <div class="codehilite"><pre><span></span><code><span class="gp">username@learn $ </span>wget http://proxy.chtc.wisc.edu/SQUID/r2015b.tar.gz
</code></pre></div>

</li>
</ol>
<h2 id="wrapper-script">Wrapper Script<a class="headerlink" href="#wrapper-script" title="Permanent link">&para;</a></h2>
<p>We will need a wrapper script to open the Matlab runtime and then run our compiled Matlab code. Our wrapper script will need to accomplish the following steps:</p>
<ul>
<li>Unpack the transferred runtime</li>
<li>Set the environment variables</li>
<li>Run our compiled matlab code</li>
</ul>
<p>Fortunately, the Matlab compiler has pre-written most of this wrapper script for us!</p>
<ol>
<li>
<p>Take a look at <code>run_matrix.sh</code>. Which of the above steps do we need to add? Once you have an idea, move to the next step.</p>
</li>
<li>
<p>We'll need to add commands to unpack the runtime (which will have been transferred with the job). Add this line to the beginning of the <code>run_matrix.sh</code> file, after <code>#!/bin/bash</code> and the comments, but before <code>exe_name=$0</code> : </p>
<div class="codehilite"><pre><span></span><code>tar -xzf r2015b.tar.gz
</code></pre></div>

</li>
<li>
<p>Look at <code>readme.txt</code> to determine what arguments our wrapper script requires. Once you have an idea, move to the next step.</p>
</li>
<li>
<p>The name of the Matlab runtime directory is a required argument to the wrapper script <code>run_matrix.sh</code>. We'll have to do a little extra work to find out the name of that directory. Run this command</p>
<div class="codehilite"><pre><span></span><code><span class="go">tar -tf r2015b.tar.gz</span>
</code></pre></div>

</li>
<li>
<p>The output of the previous command is a list of all the files in the tar.gz file. What is the name of the first folder of the path for each file? This is the name of the runtime directory, and the argument you should pass to <code>run_matrix.sh</code>.  </p>
</li>
</ol>
<h2 id="submitting-the-job">Submitting the Job<a class="headerlink" href="#submitting-the-job" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Copy an existing submit file into your current directory. The submit file we used for  <a href="../part2-ex2-prepackaged">Exercise 2.2</a> example would be a good candidate, as that example also used a wrapper script. </p>
</li>
<li>
<p>Modify your submit file for this job. </p>
</li>
<li>
<p>Check your changes against the list below.</p>
<ul>
<li>
<p>The <code>executable</code> for this job is going to be our wrapper script <code>run_matrix.sh</code>. </p>
<div class="codehilite"><pre><span></span><code>executable = run_matrix.sh
</code></pre></div>

</li>
<li>
<p>You need to transfer the compiled binary <code>matrix</code>, as well as the runtime <code>.tar.gz</code> file, using <code>transfer_input_files</code>. </p>
<div class="codehilite"><pre><span></span><code>transfer_input_files = matrix, r2015b.tar.gz
</code></pre></div>

</li>
<li>
<p>The argument for the executable (<code>run_matrix.sh</code>) is "v90", as that is the name of the un-tarred runtime directory. </p>
<div class="codehilite"><pre><span></span><code>arguments = v90
</code></pre></div>

</li>
<li>
<p>We need to request plenty of disk space for the runtime. </p>
<div class="codehilite"><pre><span></span><code>request_disk = 2GB
</code></pre></div>

</li>
</ul>
</li>
<li>
<p>Submit the job using <code>condor_submit</code>.  </p>
</li>
<li>
<p>After it completes, the job should have produced a file called <code>results.txt</code>.  </p>
</li>
</ol>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
      <a href="https://twitter.com/OSGUserSchool" target="_blank" rel="noopener" title="OSG School on Twitter" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
      <a href="https://www.facebook.com/OSGUserSchool" target="_blank" rel="noopener" title="OSG School on Facebook" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.d892486b.min.js"></script>
      
    
  </body>
</html>